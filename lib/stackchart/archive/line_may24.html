<!DOCTYPE html>
<html lang="en">
<style>

body {

  font: 18px sans-serif;
}

#select1{
  position: absolute;
  left:100px;
  top:30px;
}
#select2{
  position: absolute;
  left:700px;
  top:30px;
}
#select3{
  position: absolute;
  left:400px;
  top:30px;
}
#hovlab{
  position: absolute;
  left:30px;
  top:170px;
}

.tooltip2{
   cursor: pointer;
   position: absolute;
   left: 1100px;
   top: 20px;

   height: 46px;
   width: 50px;

}

.tooltip2 .hovertext {
  visibility: hidden;
  width: 800px;
  height: 460px;
  background-color: lightgrey;
  color: black;
  text-align: left;
  border-radius: 6px;
  padding: 15px 15px;
  right: 40px;
  top: 50px;
  opacity: 0;
  transition: opacity 1s;
  font: 18px sans-serif;

  /* Position the tooltip */
  position: absolute;
  z-index: 1;
}

.tooltip2:hover .hovertext{
  visibility: visible;
  opacity: 1;

}

circle.dot {
fill-opacity: 1 !important;
}

#button_char {   position: absolute; left: 30px; font-size: 12px; font-weight: normal; float: left; top:20px /* or whatever */ }
#paging { padding-left: 150px; font-size: 12px; font-weight: normal; float: center; }
#datatest {position:absolute;table-layout: fixed;display: block; left:1100px;} /* GRAB THIS*/
#button_char {   position: absolute; left: 30px; font-size: 12px; font-weight: normal; float: left; top:10px /* or whatever */ }

</style>

<head>
    <title>dc.js - Scatter Composite with Legend</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.5.0/css/all.css' integrity='sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU' crossorigin='anonymous'>
</head>
<body>

  <div id="button_char">
    <Button type="button" class="btn btn-primary" onclick="window.location.href = '../../home_page.html'">
      <i class="fas fa-home"></i>
    </Button>
  </div>

  <div class="row" id = "row" style = "visibility: hidden;">  <!-- /* GRAB THIS*/-->
    <table id="datatest" class="table table-striped"style=' width: 25%;right: 30px;top: 130px;overflow: scroll;height: 500px;'></table><!-- /* GRAB THIS*/-->
  </div>

  <div class ="tooltip2" id = "helpbutton"><i style = 'font-size:55px' class='fas fa-question-circle'></i>

    <span class="hovertext">
      <a style = "font-size: 24px; font-weight: bold; color:black;">PPMR-HIV Reporting by Country:</a>


      <br>
      <br>
  <a style = "color:black; font-weight:bold;">Botswana: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Burundi: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Cameroon: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Cote d'Ivoire: </a>Data reported for Central Medical Store and District Medical Store and Hospitals<br>
  <a style = "color:black; font-weight:bold;">DRC: </a>Data reported for 3 PEPFAR Provincial Warehouses<br>
  <a style = "color:black; font-weight:bold;">eSwatini: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Ghana: </a>Data reported for Central Medical Store and 10 Regional Warehouses<br>
  <a style = "color:black; font-weight:bold;">Haiti: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Lesotho: </a>Data reported for Central Medical Store and Service Delivery Points<br>
  <a style = "color:black; font-weight:bold;">Malawi: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Mozambique: </a>Data reported for Central Medical Store and 12 Provincial Warehouses<br>
  <a style = "color:black; font-weight:bold;">Namibia: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Nigeria: </a>Data reported for 12 Regional Warehouses<br>
  <a style = "color:black; font-weight:bold;">Rwanda: </a>Data reported for Central Medical Store, District Pharmacies, and Service Delivery Points<br>
  <a style = "color:black; font-weight:bold;">Uganda JMS: </a>Data reported for Joint Medical Store (JMS)<br>
  <a style = "color:black; font-weight:bold;">Uganda NMS: </a>Data reported for National Medical Store (NMS)<br>
  <a style = "color:black; font-weight:bold;">Uganda MAUL: </a>Data reported for Medical Access Uganda Limited (MAUL)<br>
  <a style = "color:black; font-weight:bold;">Vietnam: </a>Data reported for Central Medical Store and Service Delivery Points<br>
  <a style = "color:black; font-weight:bold;">Zambia: </a>Data reported for Central Medical Store<br>
  <a style = "color:black; font-weight:bold;">Zimbabwe: </a>Data reported for Central Medical Store<br>
  </span>

  </div>



<div id = "container">
  <div id="select1">
    <div>
      <a class='reset'
         href="javascript:select1.filterAll();dc.redrawAll();d3.select('div#test').style('visibility', 'hidden');d3.select('div#row').style('visibility', 'hidden');"
         style='visibility: hidden;'>reset</a>
    </div>
  </div>
  <div id="select2" onchange="d3.select('div#test').style('visibility', 'visible');d3.select('div#row').style('visibility', 'visible');">
    <div>
      <a class='reset'
         href="javascript:select2.filterAll();dc.redrawAll();d3.select('div#test').style('visibility', 'hidden');d3.select('div#row').style('visibility', 'hidden');"
         style='visibility: hidden;'>reset</a>
    </div>
  </div>
  <div id="select3" >
    <div>
      <a class='reset'
         href="javascript:select3.filterAll();dc.redrawAll();d3.select('div#test').style('visibility', 'hidden');d3.select('div#row').style('visibility', 'hidden');"
         style='visibility: hidden;'>reset</a>
    </div>
  </div>

<!-- <div class="container">
<script type="text/javascript" src="header.js"></script> -->
<div id="test" style="visibility: hidden"></div>

<div id="hovlab">Legend: (Hover to see series)</div>

<!-- <div id="select1">
   <div>
     <a class='reset'
        href='javascript:select1.filterAll();dc.redrawAll();'
        style='visibility: hidden;'>reset</a>
   </div>
</div> -->

    <script type="text/javascript" src="js/promise-polyfill.js"></script>
    <script type="text/javascript" src="js/fetch.umd.js"></script>
<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript">


function getQueryVariable(variable) {
    var query = window.location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
        }
    }
    console.log('Query variable %s not found', variable);
}
var clicked_var = getQueryVariable("id")
var clicked_var_pro = getQueryVariable("id2")



var select1 = dc.selectMenu('#select1').promptText('Select Country');
var select2 = dc.selectMenu('#select2').promptText('Select Product');
var select3 = dc.selectMenu('#select3').promptText('Select Product Category');

// select1.render();


var chart = dc.compositeChart("#test");

var datacharttable = dc.dataTable("#datatest");<!-- /* GRAB THIS*/-->

// chart.on('renderlet', function(chart) {
//   d3.select('div#test').s tyle('visibility', 'visible');
// });


d3.csv("data/master_3.csv").then(function(experiments) {

  var formatMillisecond = d3.timeFormat(".%L"),
      formatSecond = d3.timeFormat(":%S"),
      formatMinute = d3.timeFormat("%I:%M"),
      formatHour = d3.timeFormat("%I %p"),
      formatDay = d3.timeFormat("%a %d"),
      formatWeek = d3.timeFormat("%b %d"),
      formatMonth = d3.timeFormat("%b %Y"),
      formatYear = d3.timeFormat("%Y");

  var parseDate = d3.timeParse("%m/%d/%Y");

  experiments.forEach(function(x) {
    // x.projMOS = +x.projMOS;
    // x.AMI = +x.AMI;

    // x.MOS = +x.MOS;
    // x.projAMI = +x.projAMI;
    x.Order = +x.Order;
    x.projOrder = +x.projOrder;
    x.Date = d3.timeMonth(parseDate(x.Date));


    x.mosLow = 3;
    x.mosHigh = 6;

    // console.log(formatMonth(x.Date))
    // console.log(d3 .timeMonth(parseDate(x.Date)))

  });

  // create functions to generate averages for any attribute
  // function reduceAddAvg(attr) {
  //   return function(p,v) {
  //
  //       ++p.count
  //       p.sums += attr;
  //       p.averages = (p.count === 0) ? 0 : p.sums/p.count; // gaurd against dividing by zero
  //
  //     return p;
  //   };
  // }
  // function reduceRemoveAvg(attr) {
  //   return function(p,v) {
  //
  //       --p.count
  //       p.sums -= attr;
  //       p.averages = (p.count === 0) ? 0 : p.sums/p.count;
  //
  //     return p;
  //   };
  // }
  // function reduceInitAvg() {
  //   return {count:0, sums:0, averages:0};
  // }
  // mosLow          = dateDimension.group().reduceSum(function (d) {return Math.round(d.mosLow);}),
  // mosHigh          = dateDimension.group().reduceSum(function (d) {return Math.round(d.mosHigh);}),



  var ndx                 = crossfilter(experiments),
      dateDimension       = ndx.dimension(function(d) { return d.Date; }),
      // mosLow          = dateDimension.group().reduceSum(function (d) {return 3;}),
      // mosHigh          = dateDimension.group().reduceSum(function (d) {return Math.round(6);}),

      mosHigh          = dateDimension.group().reduce(
        function (p, v) {

            return p;
        },
        function (p, v) {

            return p;
        },
        function () {
            // return {days: 0, total: 0, avg: 0};
            return 6;
        }
    ),

      mosLow          = dateDimension.group().reduce(
        function (p, v) {

            return p;
        },
        function (p, v) {

            return p;
        },
        function () {
            // return {days: 0, total: 0, avg: 0};
            return Math.round(3);
        }
    ),
      // mosHigh          = dateDimension.group().reduce(reduceAddAvg(3), reduceRemoveAvg(3), reduceInitAvg),
      // mosByDate           = dateDimension.group().reduceSum(function (d) {  return d.MOS;}),
      mosByDate           = dateDimension.group().reduceSum(function (d) {
        if(d.MOS == "0"){
          return -0.006;
        }
        else{
          return d.MOS;
        }  }),
      mospByDate          = dateDimension.group().reduceSum(function (d) {
        if(d.projMOS == "0"){
          return -0.006;
        }
        else{
          return d.projMOS;
        }  }),
      amiByDate           = dateDimension.group().reduceSum(function (d) {
        if(d.AMI == "0"){
          return -0.006;
        }
        else{
          return d.AMI;
        }  }),
      pamiByDate           = dateDimension.group().reduceSum(function (d) {
        if(d.projAMI == "0"){
          return -0.006;
        }
        else{
          return d.projAMI;
        }  }),
      orderByDate        = dateDimension.group().reduceSum(function (d) {return Math.round(d.Order);}),
      porderByDate        = dateDimension.group().reduceSum(function (d) {return Math.round(d.projOrder);}),
      prodDimension       = ndx.dimension(function(d) { return d.Product; }),
      dateGroup           = dateDimension.group(),
      prodGroup           = prodDimension.group(),
      countryDimension    = ndx.dimension(function(d) { return d.Country; }),
      countryGroup        = countryDimension.group(),
      typeDimension    = ndx.dimension(function(d) { return d.Type; }),
      typeGroup        = typeDimension.group(),
      fundDimension       = ndx.dimension(function(d) { return d.Funder; }),
      fundGroup       = fundDimension.group();
      // stackGroup       = dateDimension.group().reduce(function(p, v) {
      //     p[v.Type] = (p[v.Type] || 0) + v.Speed;
      //     return p;
      // }, function(p, v) {
      //     p[v.Type] = (p[v.Type] || 0) - v.Speed;
      //     return p;
      // }, function() {
      //     return {};
      // });
      // console.log(lineGroup)
// console.log(mosByDate);

console.log(experiments)

      function remove_empty_bins(source_group) {
          return {
              all:function () {
                  return source_group.all().filter(function(d) {

                        return d.value != 0;
                  });
              }
          };
      }

      function remove_empty_bins_num(source_group) {
          return {
              all:function () {
                  return source_group.all().filter(function(d) {

                        return d.value >= 0.005 || d.value <= -0.005;

                  });
              }
          };
      }

      var mosLow2 = remove_empty_bins(mosLow);
      var mosHigh2 = remove_empty_bins(mosHigh);
      var mosByDate2 = remove_empty_bins_num(mosByDate);
      var mospByDate2 = remove_empty_bins_num(mospByDate);
      var amiByDate2 = remove_empty_bins_num(amiByDate);
      var pamiByDate2 = remove_empty_bins_num(pamiByDate);
      var orderByDate2 = remove_empty_bins(orderByDate);
      var porderByDate2 = remove_empty_bins(porderByDate);
      var prodFilt = remove_empty_bins(prodGroup);
      var countryFilt = remove_empty_bins(countryGroup);
      var typeFilt = remove_empty_bins(typeGroup);
      var dateFilt = remove_empty_bins(dateGroup);

      function sel_stack(i) {
          return function(d) {
              return d.value[i];
          };
      }
      // var mosHigh2 = mosHigh;
      // var mosByDate2 = mosByDate;
      // var mospByDate2 = mospByDate;
      // var amiByDate2 = amiByDate;
      // var pamiByDate2 = pamiByDate;
      // var orderByDate2 = orderByDate;
      // var porderByDate2 = porderByDate;
      // var prodFilt = prodGroup;
      // var countryFilt = countryGroup;
      // var typeFilt = typeGroup;

// console.log(ndx);

      // var lineFilt = lineGroup;
      // var prjFilt = lineprjGroup;
      // var prodFilt = prodGroup;
      // var countryFilt = countryGroup;
      //
      // lineDimension.filter(function(d){return d != null;})
      // prodDimension.filter(function(d){return d != null;})
      // countryDimension.filter(function(d){return d != null;})

      var format = d3.timeFormat("%b %Y");

      select1
        .dimension(countryDimension)
        .group(countryFilt)
        .controlsUseVisibility(true);
        if(typeof clicked_var !== "undefined")
        {
          var clicked_var2 = clicked_var.replace(/^(?:")(.*)(?:")$/,"$1");
          console.log(clicked_var2)
          select1.replaceFilter(clicked_var2);
        }

      select2
        .dimension(prodDimension)
        .group(prodFilt)
        .controlsUseVisibility(true);

        if(typeof clicked_var_pro !== "undefined")
        {
          var clicked_var2_pro = clicked_var_pro.replace(/^(?:")(.*)(?:")$/,"$1");
          console.log(clicked_var2_pro);
          select2.replaceFilter(clicked_var2_pro)
          // select2
          .on('renderlet', function(chart) {
            // chart.replaceFilter(clicked_var2_pro)
            console.log('eee')
            // console.log(chart)
            // console.log(chart)
            var parent = d3.select(this.parentNode);

            console.log(parent);


            d3.select('div#test').style('visibility', 'visible');
              // .attr("href", function() {
              //   return "javascript:select2.filterAll()"
              // })
          })


        }


        select3
          .dimension(typeDimension)
          .group(typeFilt)
          .controlsUseVisibility(true);

          console.log(select1)

     //  select1.dimension(lineDimension)
     // .group(lineGroup)
     // .controlsUseVisibility(true);
// chart.filter(null);

    chart
        .width(1050)
        .height(710)

  // console.log(d);
  .title(function(d) {
  // console.log(d);
  return "Date: " + format(d.key) + "\n" +
      "Value: " + Math.round(d.value*10)/10 + "\n"
      + d.Funder;
})    // .x(d3.scaleTime().domain([new Date(2018,0,1),new Date(2020,0,1)]))
        // .x(d3.scaleTime().domain(d3.extent(experiments, function(d){return d.Date;})))
        .x(d3.scaleTime())
        // .xUnits(d3.timeMonths)
        .xUnits(function(){return 30;})

        // .y(d3.scaleLinear().domain([d3.min(experiments,function(d){return +d.MOSact;})-1.1,d3.max(experiments,function(d){return +d.MOSact;})+1.1]))

        .elasticY(true)
        .elasticX(true)
        .xAxisPadding(20).xAxisPaddingUnit('day')
        .yAxisLabel("Months of Stock (MOS)",250)
        .rightYAxisLabel("Quantity",30)
          .margins({left: 310, top: 110, right: 110, bottom: 80})
        .clipPadding(10)
        .dimension(dateDimension)


        // .renderDataPoints(true)
        .brushOn(false)
        .legend(dc.legend().x(60).y(200).itemHeight(13).gap(5))
        .alignYAxes(true)
        .compose([
          dc.barChart(chart)
                  .dimension(dateDimension)
                  .group(orderByDate2, "Shipments")
                  .colors("pink")
                  .useRightYAxis(true)
                      .centerBar(true),

          dc.barChart(chart)
                  .dimension(dateDimension)
                  .group(porderByDate2, "Proj Shipments")
                  .colors("grey")
                  .useRightYAxis(true)
                      .centerBar(true),

            dc.lineChart(chart)
                .dimension(dateDimension)
                .group(amiByDate2, "AMI/AMC")
                .colors("blue")
                .useRightYAxis(true),
                // .dashStyle([6,2]),
                dc.lineChart(chart)
                    .dimension(dateDimension)
                    .group(mosByDate2, "Actual MOS")
                    .colors("green"),

                dc.lineChart(chart)
                    .dimension(dateDimension)
                    .group(pamiByDate2, "Proj AMI/AMC")
                    .colors("blue")
                    .useRightYAxis(true)
                    .dashStyle([6,2]),

            // dc.scatterPlot(chart)
            //     .group(scatterGroup, "Red Group")
            //     .colors("red"),
                // .valueAccessor(function (d) { return d.key[1] + 8; }),

                // .dashStyle([6,2]),

            dc.lineChart(chart)
                .dimension(dateDimension)
                .group(mospByDate2, "Proj MOS")
                .colors("green")
                .dashStyle([4,4]),

                dc.lineChart(chart)
                    .dimension(dateDimension)
                    .group(mosLow2, "MOS = 3")
                    .colors("red")
                    .dashStyle([4,4])
                    .dotRadius(0),



                    dc.lineChart(chart)
                        .dimension(dateDimension)
                        .group(mosHigh2, "MOS = 6")
                        .colors("orange")
                        .dashStyle([4,4])
                        .dotRadius(0)
                // .defined(function(d) { return lineGroup != null;}),




        ]);


        var fmt = d3.format('02d');
        var runDimension = ndx.dimension(function(d) {return [fmt(+d.Country),(d.Date),fmt(+d.Product),fmt(+d.Note)];})
        grouping = function (d) {return d.Facility;}
        // var lineTip = d3.tip()
        //                  .attr('class', 'd3-tip')
        //                  .offset([-10, 0])
        //                  .html(function (d) { return "<span style='color: #f0027f'>" + d.Date + "</span> : " + numberFormat(d.AMI);});
        //
        datacharttable
          .width(300)
          .height(480)
          .dimension(runDimension)
          .group(grouping)
          .size(Infinity)
          .showGroups(false)
          // .columns(['Country','Date','Product','Note'])
          .columns([
              // {
              //     label: "Country",
              //     format: function (d) { return d.Country; }
              // },
              {
                  label: "Date",
                  format: function (d) { return format(d.Date); }
              },
              // {
              //     label: "Product",
              //     format: function (d) { return d.Product; }
              // },
              {
                  label: "Note",
                  format: function (d) { return d.Note; }
              }
          ])
          .sortBy(function (d) { return [fmt(+d.Date),fmt(+d.Note)]; })
          .order(d3.descending)
        // var lineTip = d3.tip()
        //                  .attr('class', 'd3-tip')
        //                  .offset([-10, 0])
        //                  .html(function (d) { return "<span style='color: #f0027f'>" + d.Date + "</span> : " + numberFormat(d.AMI);});
        //

        chart.renderlet(function (chart) {
                    chart.selectAll("g.x text")
                      // .attr('dx', '-10')
                      .attr('dy', "0.71em")
                      .attr('transform', "rotate(-35)")
                      .attr("text-anchor", "end");
                });


dc.renderAll();
  // chart.render();


});
</script>

</div>
</body>
</html>
